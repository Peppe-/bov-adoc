<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<meta name="author" content="(((JPAContainer)))">
<title>Vaadin JPAContainer</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
</head>
<body id="_jpacontainer" class="book toc2 toc-left">
<div id="header">
<h1>Vaadin JPAContainer</h1>
<div class="details">
<span id="author" class="author">(((JPAContainer)))</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_jpacontainer.overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.overview.jpa">1.1. Java Persistence API</a></li>
<li><a href="#_jpacontainer.overview.concepts">1.2. JPAContainer Concepts</a></li>
<li><a href="#_jpacontainer.overview.documentation">1.3. Documentation and Support</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.installation">2. Installing</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.installation.download">2.1. Downloading the Package</a></li>
<li><a href="#_jpacontainer.installation.package">2.2. Installation Package Content</a></li>
<li><a href="#_jpacontainer.installation.maven">2.3. Downloading with Maven</a></li>
<li><a href="#_jpacontainer.installation.libraries">2.4. Including Libraries in Your Project</a></li>
<li><a href="#_jpacontainer.installation.configuration">2.5. Persistence Configuration</a></li>
<li><a href="#_jpacontainer.installation.troubleshooting">2.6. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.domain_model">3. Defining a Domain Model</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.domain_model.annotation">3.1. Persistence Metadata</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.usage">4. Basic Use of JPAContainer</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.usage.jpacontainerfactory">4.1. Creating <span class="class">JPAContainer</span> with <span class="class">JPAContainerFactory</span></a></li>
<li><a href="#_jpacontainer.usage.entitites">4.2. Creating and Accessing Entities</a></li>
<li><a href="#_jpacontainer.usage.nested_properties">4.3. Nested Properties</a></li>
<li><a href="#_jpacontainer.usage.hierarchical">4.4. Hierarchical Container</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.entityprovider">5. Entity Providers</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.entityprovider.built_in">5.1. Built-In Entity Providers</a></li>
<li><a href="#_jpacontainer.entityprovider.jndi">5.2. Using JNDI Entity Providers in JEE6 Environment</a></li>
<li><a href="#_jpacontainer.entityprovider.ejb">5.3. Entity Providers as Enterprise Beans</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.filtering">6. Filtering <span class="class">JPAContainer</span></a></li>
<li><a href="#_jpacontainer.filtering.criteria_api">7. Querying with the Criteria API</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.filtering.criteria_api.filters">7.1. Filtering the Query</a></li>
<li><a href="#_jpacontainer.filtering.criteria_api.compatibility">7.2. Compatibility</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.fieldfactory">8. Automatic Form Generation</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.fieldfactory.configuring">8.1. Configuring the Field Factory</a></li>
<li><a href="#_jpacontainer.fieldfactory.using">8.2. Using the Field Factory</a></li>
<li><a href="#_jpacontainer.fieldfactory.masterdetaileditor">8.3. Master-Detail Editor</a></li>
</ul>
</li>
<li><a href="#_jpacontainer.hibernate">9. Using JPAContainer with Hibernate</a>
<ul class="sectlevel2">
<li><a href="#_jpacontainer.hibernate.lazyloading">9.1. Lazy loading</a></li>
<li><a href="#_jpacontainer.hibernate.em_per_request">9.2. The EntityManager-Per-Request pattern</a></li>
<li><a href="#_jpacontainer.hibernate.joins">9.3. Joins in Hibernate vs EclipseLink</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes the use of the Vaadin JPAContainer add-on.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.overview">1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vaadin JPAContainer add-on makes it possible to bind user interface components to a database easily using the Java Persistence API (JPA). It is an implementation of the <span class="interface">Container</span> interface described in <a href="#_datamodel.container">datamodel.container</a>.
It supports a typical three-layer application architecture with an intermediate <em>domain model</em> between the user interface and the data access layer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/jpacontainer/three-layer-architecture-lo.png" alt="three layer architecture lo">
</div>
<div class="title">Figure 1. Three-Layer Architecture Using JPAContainer And JPA</div>
</div>
<div class="paragraph">
<p>The role of Java Persistence API is to handle persisting the domain model in the database.
The database is typically a relational database.
Vaadin JPAContainer binds the user interface components to the domain model and handles database access with JPA transparently.</p>
</div>
<div class="paragraph">
<p>JPA is really just an API definition and has many alternative implementations.
Vaadin JPAContainer supports especially EclipseLink, which is the reference implementation of JPA, and Hibernate.
Any other compliant implementation should work just as well.
The architecture of an application using JPAContainer is shown in <a href="#_figure.jpacontainer.overview.detailed_architecture">figure.jpacontainer.overview.detailed-architecture</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/jpacontainer/detailed-architecture-lo.png" alt="detailed architecture lo">
</div>
<div class="title">Figure 2. JPAContainer Architecture</div>
</div>
<div class="paragraph">
<p>Vaadin JPAContainer also plays together with the Vaadin support for Java Bean Validation (JSR 303).</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.overview.jpa">1.1. Java Persistence API</h3>
<div class="paragraph">
<p>Java Persistence API (JPA) is an API for object-relational mapping (ORM) of Java objects to a relational database.
In JPA and entity-relationship modeling in general, a Java class is considered an <em>entity</em>.
Class (or entity) instances correspond with a row in a database table and member variables of a class with columns.
Entities can also have relationships with other entities.</p>
</div>
<div class="paragraph">
<p>The object-relational mapping is illustrated in <a href="#_figure.jpacontainer.overview.jpa.orm">figure.jpacontainer.overview.jpa.orm</a> with two entities with a one-to-many relationship.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/jpacontainer/jpa-mapping-graphic-lo.png" alt="jpa mapping graphic lo">
</div>
<div class="title">Figure 3. Object-Relational Mapping</div>
</div>
<div class="paragraph">
<p>The entity relationships are declared with metadata.
With Vaadin JPAContainer, you provide the metadata with annotations in the entity classes.
The JPA implementation uses reflection to read the annotations and defines a database model automatically from the class definitions.
Definition of the domain model and the annotations are described in <a href="#_jpacontainer.domain_model.annotation">jpacontainer.domain-model.annotation</a>.</p>
</div>
<div class="paragraph">
<p>The main interface in JPA is the <span class="interface">EntityManager</span>, which allows making different kinds of queries either with the Java Persistence Query Language (JPQL), native SQL, or the Criteria API in JPA 2.0.
You can always use the interface directly as well, using Vaadin JPAContainer only for binding the data to the user interface.</p>
</div>
<div class="paragraph">
<p>Vaadin JPAContainer supports JPA 2.0 (JSR 317). It is available under the Apache License 2.0.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.overview.concepts">1.2. JPAContainer Concepts</h3>
<div class="paragraph">
<p>The <span class="class">JPAContainer</span> is an implementation of the Vaadin <span class="interface">Container</span> interface that you can bind to user interface components such as <span class="class">Table</span>, <span class="class">ComboBox</span>, etc.</p>
</div>
<div class="paragraph">
<p>The data access to the persistent entities is handled with a <em>entity provider</em>, as defined in the <span class="interface">EntityProvider</span> interface.
JPAContainer provides a number of different entity providers for different use cases and optimizations.
The built-in providers are described in <a href="#_jpacontainer.entityprovider">jpacontainer.entityprovider</a>.</p>
</div>
<div class="paragraph">
<p><span class="class">JPAContainer</span> is by default <em>unbuffered</em>, so that any entity property changes are written immediately to the database when you call <span class="method">setValue()</span> for a property, or when a user edits a bound field.
A container can be set as <em>buffered</em>, so that changes are written on calling <span class="method">commit()</span>.
Buffering can be done both at item level, such as when updating item property values, or at container level, such as when adding or deleting items.
Only <em>batchable</em>                containers, that is, containers with a batchable entity provider, can be buffered.
Note that buffering is recommended for situations where two users could update the same entity simultaneously, and when this would be a problem.
In an unbuffered container, the entity is refreshed before writing an update, so the last write wins and a conflicting simultaneous update written before it is lost.
A buffered container throws an <span class="class">OptimisticLockException</span> when two users edit the same item (an unbuffered container never throws it), thereby allowing to handle the situation with application logic.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.overview.documentation">1.3. Documentation and Support</h3>
<div class="paragraph">
<p>In addition to this chapter in the book, the installation package includes the following documentation about JPAContainer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>API Documentation</p>
</li>
<li>
<p>JPAContainer Tutorial</p>
</li>
<li>
<p>JPAContainer AddressBook Demo</p>
</li>
<li>
<p>JPAContainer Demo</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.installation">2. Installing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vaadin JPAContainer can be installed either as an installation package, downloaded from the Vaadin Directory, or as a Maven dependency.
You can also create a new JPAContainer-enabled Vaadin project using a Maven archetype.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.installation.download">2.1. Downloading the Package</h3>
<div class="paragraph">
<p>Vaadin JPAContainer is available for download from the &lt;&lt;,Vaadin Directory&gt;&gt;.
Please see <a href="#_addons.downloading">addons.downloading</a> for basic instructions for downloading from Directory.
The download page also gives the dependency declaration needed for retrieving the library with Maven.</p>
</div>
<div class="paragraph">
<p>JPAContainer is a purely server-side component, so it does not include a widget set that you would need to compile.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.installation.package">2.2. Installation Package Content</h3>
<div class="paragraph">
<p>Once extracted to a local folder, the contents of the installation directory are as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em class="path">README</em></dt>
<dd>
<p>A readme file describing the package contents.</p>
</dd>
<dt class="hdlist1"><em class="path">LICENSE</em></dt>
<dd>
<p>The full license text for the library.</p>
</dd>
<dt class="hdlist1"><em class="path">vaadin-jpacontainer-3.x.x.jar</em></dt>
<dd>
<p>The actual Vaadin JPAContainer library.</p>
</dd>
<dt class="hdlist1"><em class="path">vaadin-jpacontainer-3.x.x-sources.jar</em></dt>
<dd>
<p>Source JAR for the library.
You can use it for example in Eclipse by associating the JavaDoc JAR with the JPAContainer JAR in the build path settings of your project.</p>
</dd>
<dt class="hdlist1"><em class="path">jpacontainer-tutorial.pdf</em></dt>
<dd>
<p>The tutorial in PDF format.</p>
</dd>
<dt class="hdlist1"><em class="path">jpacontainer-tutorial-html</em></dt>
<dd>
<p>The tutorial in HTML format.</p>
</dd>
<dt class="hdlist1"><em class="path">jpacontainer-addressbook-demo</em></dt>
<dd>
<p>The JPAContainer AddressBook Demo project covered in this tutorial.
You can compile and package the application as a WAR with "mvn " or launch it in the Jetty web browser with "mvn ". You can also import the demo project in Eclipse.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.installation.maven">2.3. Downloading with Maven</h3>
<div class="paragraph">
<p>The &lt;&lt;,download page in Vaadin
                Directory&gt;&gt; gives the dependency declaration needed for retrieving the Vaadin JPAContainer library with Maven.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
   &lt;groupId&gt;com.vaadin.addon&lt;/groupId&gt;
   &lt;artifactId&gt;jpacontainer-addon&lt;/artifactId&gt;
   &lt;version&gt;3.1.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <span class="literal">LATEST</span> version tag to automatically download the latest stable release or use a specific version number as done above.</p>
</div>
<div class="paragraph">
<p>See <a href="#_addons.maven">addons.maven</a> for detailed instructions for using a Vaadin add-on with Maven.</p>
</div>
<div class="sect3">
<h4 id="_jpacontainer.installation.maven.archetype">2.3.1. Using the Maven Archetype</h4>
<div class="paragraph">
<p>If you wish to create a new JPAContainer-enabled Vaadin project with Maven, you can use the <span class="literal">vaadin-archetype-jpacontainer</span> archetype.
Please see <a href="#_getting_started.maven">getting-started.maven</a> for details on creating a Vaadin project with a Maven archetype.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.installation.libraries">2.4. Including Libraries in Your Project</h3>
<div class="paragraph">
<p>The Vaadin JPAContainer JAR must be included in the library folder of the web application.
It is located in <em class="path">WEB-INF/lib</em> path in a web application.
In a normal Eclipse web projects the path is <em class="path">WebContent/WEB-INF/lib</em>.
In Maven projects the JARs are automatically included in the folder, as long as the dependencies are defined correctly.</p>
</div>
<div class="paragraph">
<p>You will need the following JARs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vaadin Framework Library</p>
</li>
<li>
<p>Vaadin JPAContainer</p>
</li>
<li>
<p>Java Persistence API 2.0 (javax.persistence package)</p>
</li>
<li>
<p>JPA implementation (EclipseLink, Hibernate, &#8230;&#8203;)</p>
</li>
<li>
<p>Database driver or embedded engine (H2, HSQLDB, MySQL, PostgreSQL, &#8230;&#8203;)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you use Eclipse, the Vaadin Framework library is automatically downloaded and updated by the Vaadin Plugin for Eclipse.</p>
</div>
<div class="paragraph">
<p>To use bean validation, you need an implementation of the Bean Validation, such as Hibernate Validator.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.installation.configuration">2.5. Persistence Configuration</h3>
<div class="paragraph">
<p>Persistence configuration is done in a <em class="path">persistence.xml</em> file.
In a regular Eclipse project, it should be located in <em class="path">WebContent/WEB-INF/classes/META-INF</em>.
In a Maven project, it should be in <em class="path">src/main/resources/META-INF</em>.
The configuration includes the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The persistence unit</p>
</li>
<li>
<p>The persistence provider</p>
</li>
<li>
<p>The database driver and connection</p>
</li>
<li>
<p>Logging</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <em class="path">persistence.xml</em> file is packaged as <em class="path">WEB-INF/classes/META-INF/persistence.xml</em> in the WAR.
This is done automatically in a Maven build at the package phase.</p>
</div>
<div class="sect3">
<h4 id="_jpacontainer.installation.configuration.schema">2.5.1. Persistence XML Schema</h4>
<div class="paragraph">
<p>The beginning of a <em class="path">persistence.xml</em> file defines the used schema and namespaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;persistence
    xmlns="http://java.sun.com/xml/ns/persistence"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
      http://java.sun.com/xml/ns/persistence
      http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"
    version="2.0"&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.installation.configuration.unit">2.5.2. Defining the Persistence Unit</h4>
<div class="paragraph">
<p>The root element of the persistence definition is persistence-unit.
The name of the persistence unit is needed for creating <span class="class">JPAContainer</span> instances from a <span class="class">JPAContainerFactory</span>, as described in <a href="#_jpacontainer.usage.jpacontainerfactory">jpacontainer.usage.jpacontainerfactory</a> or when creating a JPA entity manager.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;persistence-unit name="addressbook"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Persistence provider is the JPA provider implementation used.
For example, the JPAContainer AddressBook demo uses the EclipseLink JPA, which is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;provider&gt;
    org.eclipse.persistence.jpa.PersistenceProvider
&lt;/provider&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The persistent classes need to be listed with a <span class="literal">&lt;class&gt;</span> element.
Alternatively, you can allow including unlisted classes for persistence by overriding the <span class="literal">exclude-unlisted-classes</span> default as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;exclude-unlisted-classes&gt;false&lt;/exclude-unlisted-classes&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JPA provider specific parameters are given under the <span class="literal">properties</span> element.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;properties&gt;
   ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following section we give parameters for the EclipseLink JPA and H2 database used in the JPAContainer AddressBook Demo.
Please refer to the documentation of the JPA provider you use for a complete reference of parameters.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.installation.configuration.database">2.5.3. Database Connection</h4>
<div class="paragraph">
<p>EclipseLink allows using JDBC for database connection.
For example, if we use the the H2 database, we define its driver here as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;property name="eclipselink.jdbc.platform"
 value="org.eclipse.persistence.platform.database.H2Platform"/&gt;
&lt;property name="eclipselink.jdbc.driver"
          value="org.h2.Driver" /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Database connection is specified with a URL.
For example, using an embedded H2 database stored in the home directory it would be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;property name="eclipselink.jdbc.url"
          value="jdbc:h2:~/my-app-h2db"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A hint: when using an embedded H2 database while developing a Vaadin application in Eclipse, you may want to add <span class="literal">;FILE_LOCK=NO</span> to the URL to avoid locking issues when redeploying.</p>
</div>
<div class="paragraph">
<p>We can just use the default user name and password for the H2 database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;property name="eclipselink.jdbc.user" value="sa"/&gt;
&lt;property name="eclipselink.jdbc.password" value="sa"/&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.installation.configuration.logging">2.5.4. Logging Configuration</h4>
<div class="paragraph">
<p>JPA implementations as well as database engines like to produce logs and they should be configured in the persistence configuration.
For example, if using EclipseLink JPA, you can get log that includes all SQL statements with the <span class="literal">FINE</span> logging level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;property name="eclipselink.logging.level"
          value="FINE" /&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.installation.configuration.other">2.5.5. Other Settings</h4>
<div class="paragraph">
<p>The rest is some Data Definition Language settings for EclipseLink.
During development, when we use generated example data, we want EclipseLink to drop tables before trying to create them.
In production environments, you should use <span class="literal">create-tables</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;property name="eclipselink.ddl-generation"
          value="drop-and-create-tables" /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And there is no need to generate SQL files, just execute them directly to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;property name="eclipselink.ddl-generation.output-mode"
          value="database"/&gt;
	  &lt;/properties&gt;
 &lt;/persistence-unit&gt;
&lt;/persistence&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.installation.troubleshooting">2.6. Troubleshooting</h3>
<div class="paragraph">
<p>Below are some typical errors that you might get when using JPA.
These are not specific to JPAContainer.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><span class="class">javax.persistence.PersistenceException</span>: No Persistence provider for EntityManager</dt>
<dd>
<p>The most typical cases for this error are that the persistence unit name is wrong in the source code or in the <em class="path">persistence.xml</em> file, or that the <em class="path">persistence.xml</em> is at a wrong place or has some other problem.
Make sure that the persistence unit name matches and the <em class="path">persistence.xml</em> is in <em class="path">WEB-INF/classes/META-INF</em> folder in the deployment.</p>
</dd>
<dt class="hdlist1"><span class="class">java.lang.IllegalArgumentException</span>: The class is not an entity</dt>
<dd>
<p>The class is missing from the set of persistent entities.
If the <em class="path">persistence.xml</em> does not have  defined as <span class="literal">false</span>, the persistent entity classes should be listed with <span class="literal">&lt;class&gt;</span> elements.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.domain_model">3. Defining a Domain Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Developing a persistent application begins with defining a domain model.
A domain model consists of a number of entities (classes) and relationships between them.</p>
</div>
<div class="paragraph">
<p><a href="#_figure.jpacontainer.domain_model">figure.jpacontainer.domain-model</a> illustrates a simple domain model as a UML class diagram.
It has two entities: <span class="class">Country</span> and <span class="class">Person</span>.
They have a "country has persons" relationship.
This is a <em>one-to-many
            relationship</em> with one country having many persons, each of which belongs to just one country.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/jpacontainer/domain-model-lo.png" alt="domain model lo">
</div>
<div class="title">Figure 4. A Domain Model</div>
</div>
<div class="paragraph">
<p>Realized in Java, the classes are as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>public class Country {
    private Long   id;
    private String name;
    private Set&lt;Person&gt; persons;

    ... setters and getters ...
}

public class Person {
    private Long    id;
    private String  name;
    private Integer age;
    private Country country;

    ... setters and getters ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should make the classes proper beans by defining a default constructor and implementing the <span class="interface">Serializable</span> interface.
A default constructor is required by the JPA entity manager for instantiating entities.
Having the classes serializable is not required but often useful for other reasons.</p>
</div>
<div class="paragraph">
<p>After you have a basic domain model, you need to define the entity relationship metadata by annotating the classes.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.domain_model.annotation">3.1. Persistence Metadata</h3>
<div class="paragraph">
<p>The entity relationships are defined with metadata.
The metadata can be defined in an XML metadata file or with Java annotations defined in the  package.
With Vaadin JPAContainer, you need to provide the metadata as annotations.</p>
</div>
<div class="paragraph">
<p>For example, if we look at the Person class in the JPAContainer AddressBook Demo, we define various database-related metadata for the member variables of a class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Entity
public class Person {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long    id;

    private String  name;
    private Integer age;

    @ManyToOne
    private Country country;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JPA implementation uses reflection to read the annotations and defines a database model automatically from the class definitions.</p>
</div>
<div class="paragraph">
<p>Let us look at some of the basic JPA metadata annotations.
The annotations are defined in the  package.
Please refer to JPA reference documentation for the complete list of possible annotations.</p>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.metadata.entity">3.1.1. Annotation: <span class="literal">@Entity</span></h4>
<div class="paragraph">
<p>Each class that is enabled as a persistent entity must have the <span class="literal">@Entity</span> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Entity
public class Country {</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.id">3.1.2. Annotation: <span class="literal">@Id</span></h4>
<div class="paragraph">
<p>Entities must have an identifier that is used as the primary key for the table.
It is used for various purposes in database queries, most commonly for joining tables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Id
@GeneratedValue(strategy = GenerationType.AUTO)
private Long id;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The identifier is generated automatically in the database.
The strategy for generating the identifier is defined with the <span class="literal">@GeneratedValue</span> annotation.
Any generation type should work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.onetoone">3.1.3. Annotation: <span class="literal">@OneToOne</span></h4>
<div class="paragraph">
<p>The <span class="literal">@OneToOne</span> annotation describes a one-to-one relationship where each entity of one type is associated with exactly one entity of another type.
For example, the postal address of a person could be given as such.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@OneToOne
private Address address;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the JPAContainer <span class="class">FieldFactory</span> to automatically create fields for a form, the <span class="literal">@OneToOne</span> relationship generates a nested <span class="class">Form</span> to edit the data.
See <a href="#_jpacontainer.fieldfactory">jpacontainer.fieldfactory</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.embedded">3.1.4. Annotation: <span class="literal">@Embedded</span></h4>
<div class="paragraph">
<p>Just as with the <span class="literal">@OneToOne</span> annotation, <span class="literal">@Embedded</span> describes a one-to-one relationship, but says that the referenced entity should be stored as columns in the same table as the referencing entity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Embedded
private Address address;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The referenced entity class must have <span class="literal">@Embeddable</span>                    annotation.</p>
</div>
<div class="paragraph">
<p>The JPAContainer <span class="class">FieldFactory</span> generates a nested <span class="class">Form</span> for <span class="literal">@Embedded</span>, just as with <span class="literal">@OneToOne</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.onetomany">3.1.5. Annotation: <span class="literal">@OneToMany</span></h4>
<div class="paragraph">
<p>The <span class="class">Country</span> entity in the domain model has a <em>one-to-many</em> relationship with the <span class="class">Person</span> entity ("country has persons"). This relationship is represented with the <span class="literal">@OneToMany</span>                    annotation.
The  parameter names the corresponding back-reference in the <span class="class">Person</span>                    entity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@OneToMany(mappedBy = "country")
private Set&lt;Person&gt; persons;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using the JPAContainer <span class="class">FieldFactory</span> to automatically create fields for a form, the <span class="literal">@OneToMany</span> relationship generates a <span class="class">MasterDetailEditor</span> for editing the items.
See <a href="#_jpacontainer.fieldfactory">jpacontainer.fieldfactory</a> for more details.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.elementcollection">3.1.6. Annotation: <span class="literal">@ElementCollection</span></h4>
<div class="paragraph">
<p>The <span class="literal">@ElementCollection</span> annotation can be used for one-to-many relationships to a collection of basic values such as <span class="class">String</span> or <span class="class">Integer</span>, or to entities annotated as <span class="literal">@Embeddable</span>.
The referenced entities are stored in a separate table defined with a <span class="literal">@CollectionTable</span> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@ElementCollection
@CollectionTable(
    name="OLDPEOPLE",
    joinColumns=@JoinColumn(name="COUNTRY_ID"))
private Set&lt;Person&gt; persons;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JPAContainer <span class="class">FieldFactory</span> generates a <span class="class">MasterDetailEditor</span> for the <span class="literal">@ElementCollection</span> relationship, just as with <span class="literal">@OneToMany</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.manytoone">3.1.7. Annotation: <span class="literal">@ManyToOne</span></h4>
<div class="paragraph">
<p>Many people can live in the same country.
This would be represented with the <span class="literal">@ManyToOne</span> annotation in the <span class="class">Person</span> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@ManyToOne
private Country country;</code></pre>
</div>
</div>
<div class="paragraph">
<p>JPAContainer <span class="class">FieldFactory</span> generates a <span class="class">NativeSelect</span> for selecting an item from the collection.
You can do so yourself as well in a custom field factory.
Doing so you need to pay notice not to confuse the container between the referenced entity and its ID, which could even result in insertion of false entities in the database in some cases.
You can handle conversion between an entity and the entity ID using the <span class="class">SingleSelectConverter</span> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Override
public &lt;T extends Field&gt; T createField(Class&lt;?&gt; dataType,
                                       Class&lt;T&gt; fieldType) {
    if (dataType == Country.class) {
       JPAContainer&lt;Country&gt; countries =
           JPAContainerFactory.make(Country.class, "mypunit");
       ComboBox cb = new ComboBox(null, countries);
       cb.setConverter(new SingleSelectConverter&lt;Country&gt;(cb));
       return (T) cb;
    }
    return super.createField(dataType, fieldType);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JPAContainer <span class="class">FieldFactory</span> uses the translator internally, so using it also avoids the problem.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.domain_model.annotation.transient">3.1.8. Annotation: <span class="literal">@Transient</span></h4>
<div class="paragraph">
<p>JPA assumes that all entity properties are persisted.
Properties that should not be persisted should be marked as transient with the <span class="literal">@Transient</span> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Transient
private Boolean superDepartment;
...
@Transient
public String getHierarchicalName() {
...</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.usage">4. Basic Use of JPAContainer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vaadin JPAContainer offers a highly flexible API that makes things easy in simple cases while allowing extensive flexibility in demanding cases.
To begin with, it is a <span class="class">Container</span>, as described in <a href="#_datamodel.container">datamodel.container</a>.</p>
</div>
<div class="paragraph">
<p>In this section, we look how to create and use <span class="class">JPAContainer</span> instances.
We assume that you have defined a domain model with JPA annotations, as described in the previous section.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.usage.jpacontainerfactory">4.1. Creating <span class="class">JPAContainer</span> with <span class="class">JPAContainerFactory</span></h3>
<div class="paragraph">
<p>The <span class="class">JPAContainerFactory</span> is the easy way to create [class]+JPAContainer+s.
It provides a set of <em>make&#8230;&#8203;()</em> factory methods for most cases that you will likely meet.
Each factory method uses a different type of entity provider, which are described in <a href="#_jpacontainer.entityprovider">jpacontainer.entityprovider</a>.</p>
</div>
<div class="paragraph">
<p>The factory methods take the class type of the entity class as the first parameter.
The second parameter is either a persistence unit name (persistence context) or an <span class="class">EntityManager</span> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Create a persistent person container
JPAContainer&lt;Person&gt; persons =
    JPAContainerFactory.make(Person.class, "book-examples");

// You can add entities to the container as well
persons.addEntity(new Person("Marie-Louise Meilleur", 117));

// Set up sorting if the natural order is not appropriate
persons.sort(new String[]{"age", "name"},
             new boolean[]{false, false});

// Bind it to a component
Table personTable = new Table("The Persistent People", persons);
personTable.setVisibleColumns("id","name","age");
layout.addComponent(personTable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s that easy.
In fact, if you run the above code multiple times, you&#8217;ll be annoyed by getting a new set of persons for each run - that&#8217;s how persistent the container is.
The basic <span class="method">make()</span>                uses a <span class="class">CachedMutableLocalEntityProvider</span>, which allows modifying the container and its entities, as we do above by adding new entities.</p>
</div>
<div class="paragraph">
<p>When using just the persistence unit name, the factory creates an instance of <span class="class">EntityManagerFactory</span> for the persistence unit and uses it to build entity managers.
You can also create the entity managers yourself, as described later.</p>
</div>
<div class="paragraph">
<p>The entity providers associated with the different factory methods are as follows:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. <span class="class">JPAContainerFactory</span> Methods</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">make()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CachingMutableLocalEntityProvider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">makeReadOnly()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CachingLocalEntityProvider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">makeBatchable()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BatchableLocalEntityProvider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">makeNonCached()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MutableLocalEntityProvider</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">makeNonCachedReadOnly()</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">LocalEntityProvider</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><span class="class">JPAContainerFactory</span> holds a cache of entity manager factories for the different persistence units, making sure that any entity manager factory is created only once, as it is a heavy operation.
You can access the cache to get a new entity manager with the <span class="method">createEntityManagerForPersistenceUnit()</span> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Get an entity manager
EntityManager em = JPAContainerFactory.
    createEntityManagerForPersistenceUnit("book-examples");

// Do a query
em.getTransaction().begin();
em.createQuery("DELETE FROM Person p").executeUpdate();
em.persist(new Person("Jeanne Calment", 122));
em.persist(new Person("Sarah Knauss", 119));
em.persist(new Person("Lucy Hannah", 117));
em.getTransaction().commit();

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that if you use update the persistent data with an entity manager outside a <span class="class">JPAContainer</span> bound to the data, you need to refresh the container as described in <a href="#_jpacontainer.usage.entitites">jpacontainer.usage.entitites</a>.</p>
</div>
<div class="sect3">
<h4 id="_jpacontainer.usage.jpacontainerfactory.thehardway">4.1.1. Creating <span class="class">JPAContainer</span> Manually</h4>
<div class="paragraph">
<p>While it is normally easiest to use a <span class="class">JPAContainerFactory</span> to create <span class="class">JPAContainer</span> instances, you may need to create them manually.
It is necessary, for example, when you need to use a custom entity provider or extend <span class="class">JPAContainer</span>.</p>
</div>
<div class="paragraph">
<p>First, we need to create an entity manager and then the entity provider, which we bind to a <span class="class">JPAContainer</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// We need a factory to create entity manager
EntityManagerFactory emf =
    Persistence.createEntityManagerFactory("book-examples");

// We need an entity manager to create entity provider
EntityManager em = emf.createEntityManager();

// We need an entity provider to create a container
CachingMutableLocalEntityProvider&lt;Person&gt; entityProvider =
    new CachingMutableLocalEntityProvider&lt;Person&gt;(Person.class,
                                                  em);

// And there we have it
JPAContainer&lt;Person&gt; persons =
        new JPAContainer&lt;Person&gt; (Person.class);
persons.setEntityProvider(entityProvider);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could save the first step by asking the entity manager from the <span class="class">JPAContainerFactory</span>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.usage.entitites">4.2. Creating and Accessing Entities</h3>
<div class="paragraph">
<p>JPAContainer integrates with the JPA entity manager, which you would normally use to create and access entities with JPA.
You can use the entity manager for any purposes you may have, and then <span class="class">JPAContainer</span> to bind entities to user interface components such as <span class="class">Table</span>, <span class="class">Tree</span>, any selection components, or a <span class="class">Form</span>.</p>
</div>
<div class="paragraph">
<p>You can add new entities to a <span class="class">JPAContainer</span> with the <span class="method">addEntity()</span> method.
It returns the item ID of the new entity.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Country france = new Country("France");
Object itemId = countries.addEntity(france);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The item ID used by <span class="class">JPAContainer</span> is the value of the ID property (column) defined with the <span class="literal">@Id</span>                annotation.
In our <span class="class">Country</span> entity, it would have <span class="class">Long</span> type.
It is generated by the entity manager when the entity is persisted and set with the setter for the ID proeprty.</p>
</div>
<div class="paragraph">
<p>Notice that the <span class="method">addEntity()</span> method does <em>not</em> attach the entity instance given as the parameter.
Instead, it creates a new instance.
If you need to use the entity for some purpose, you need to get the actual managed entity from the container.
You can get it with the item ID returned by <span class="method">addEntity()</span>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Create a new entity and add it to a container
Country france = new Country("France");
Object itemId = countries.addEntity(france);

// Get the managed entity
france = countries.getItem(itemId).getEntity();

// Use the managed entity in entity references
persons.addEntity(new Person("Jeanne Calment", 122, france));</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.usage.entitites.items">4.2.1. Entity Items</h4>
<div class="paragraph">
<p>The <span class="method">getItem()</span> method is defined in the normal Vaadin <span class="interface">Container</span> interface.
It returns an <span class="class">EntityItem</span>, which is a wrapper over the actual entity object.
You can get the entity object with <span class="method">getEntity()</span>.</p>
</div>
<div class="paragraph">
<p>An <span class="class">EntityItem</span> can have a number of states: persistent, modified, dirty, and deleted.
The dirty and deleted states are meaningful when using <em>container buffering</em>, while the modified state is meaningful when using <em>item
                    buffering</em>.
Both levels of buffering can be used together - user input is first written to the item buffer, then to the entity instance, and finally to the database.</p>
</div>
<div class="paragraph">
<p>The <span class="method">isPersistent()</span> method tells if the item is actually persistent, that is, fetched from a persistent storage, or if it is just a transient entity created and buffered by the container.</p>
</div>
<div class="paragraph">
<p>The <span class="method">isModified()</span> method checks whether the <span class="class">EntityItem</span> has changes that are not yet committed to the entity instance.
It is only relevant if the item buffering is enabled with <span class="method">setBuffered(true)</span> for the item.</p>
</div>
<div class="paragraph">
<p>The <span class="method">isDirty()</span> method checks whether the entity object has been modified after it was fetched from the entity provider.
The dirty state is possible only when buffering is enabled for the container.</p>
</div>
<div class="paragraph">
<p>The <span class="method">isDeleted()</span> method checks whether the item has been marked for deletion with <span class="method">removeItem()</span> in a buffered container.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.usage.entitites.refreshing">4.2.2. Refreshing JPAContainer</h4>
<div class="paragraph">
<p>In cases where you change <span class="class">JPAContainer</span> items outside the container, for example by through an <span class="interface">EntityManager</span>, or when they change in the database, you need to refresh the container.</p>
</div>
<div class="paragraph">
<p>The <span class="interface">EntityContainer</span> interface implemented by <span class="class">JPAContainer</span> provides two methods to refresh a container.
The <span class="method">refresh()</span>                    discards all container caches and buffers and refreshes all loaded items in the container.
All changes made to items provided by the container are discarded.
The <span class="method">refreshItem()</span>                    refreshes a single item.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.usage.nested_properties">4.3. Nested Properties</h3>
<div class="paragraph">
<p>If you have a one-to-one or many-to-one relationship, you can define the properties of the referenced entity as <em>nested</em> in a <span class="class">JPAContainer</span>.
This way, you can access the properties directly through the container of the first entity type as if they were its properties.
The interface is the same as with <span class="class">BeanContainer</span> described in <a href="#_datamodel.container.beancontainer">datamodel.container.beancontainer</a>.
You just need to add each nested property with <span class="method">addNestedContainerProperty()</span>                using dot-separated path to the property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Have a persistent container
JPAContainer&lt;Person&gt; persons =
    JPAContainerFactory.make(Person.class, "book-examples");

// Add a nested property to a many-to-one property
persons.addNestedContainerProperty("country.name");

// Show the persons in a table, except the "country" column,
// which is an object - show the nested property instead
Table personTable = new Table("The Persistent People", persons);
personTable.setVisibleColumns("name", "age", "country.name");

// Have a nicer caption for the country.name column
personTable.setColumnHeader("country.name", "Nationality");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result is shown in <a href="#_figure.jpacontainer.usage.nested_properties">figure.jpacontainer.usage.nested-properties</a>.
Notice that the <span class="literal">country</span> property in the container remains after adding the nested property, so we had to make that column invisible.
Alternatively, we could have redefined the <span class="method">toString()</span> method in the country object to show the name instead of an object reference.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/jpacontainer/nested-properties.png" alt="nested properties">
</div>
<div class="title">Figure 5. Nested Properties</div>
</div>
<div class="paragraph">
<p>You can use the <span class="literal">*</span> wildcard to add all properties in a nested item, for example, "<span class="literal">country.*</span>".</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.usage.hierarchical">4.4. Hierarchical Container</h3>
<div class="paragraph">
<p><span class="class">JPAContainer</span> implements the <span class="interface">Container.Hierarchical</span> interface and can be bound to hierarchical components such as a <span class="class">Tree</span> or <span class="class">TreeTable</span>.
The feature requires that the hierarchy is represented with a <em>parent</em> property that refers to the parent item.
At database level, this would be a column with IDs.</p>
</div>
<div class="paragraph">
<p>The representation would be as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Entity
public class CelestialBody implements Serializable {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long    id;

    private String  name;

    @ManyToOne
    private CelestialBody parent;
    ...
} ...

// Create some entities
CelestialBody sun     = new CelestialBody("The Sun", null);
CelestialBody mercury = new CelestialBody("Mercury", sun);
CelestialBody venus   = new CelestialBody("Venus", sun);
CelestialBody earth   = new CelestialBody("Earth", sun);
CelestialBody moon    = new CelestialBody("The Moon", earth);
CelestialBody mars    = new CelestialBody("Mars", sun);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You set up a <span class="class">JPAContainer</span> to have hierarchy by calling <span class="method">setParentProperty()</span> with the name of the property that refers to the parent.
Coincidentally, it is named "<span class="literal">parent</span>" in the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Create the container
JPAContainer&lt;CelestialBody&gt; bodies =
    JPAContainerFactory.make(CelestialBody.class, "my-unit");

// Set it up for hierarchical representation
bodies.setParentProperty("parent");

// Bind it to a hierarhical component
Tree tree = new Tree("Celestial Bodies", bodies);
tree.setItemCaptionMode(Tree.ITEM_CAPTION_MODE_PROPERTY);
tree.setItemCaptionPropertyId("name");</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <span class="method">rootItemIds()</span> to acquire the item IDs of the root elements with no parent.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Expand the tree
for (Object rootId: bodies.rootItemIds())
    tree.expandItemsRecursively(rootId);</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.usage.hierarchical.unsupported">4.4.1. Unsupported Hierarchical Features</h4>
<div class="paragraph">
<p>Using <span class="method">setParent()</span> in the container to define parenthood is not supported.</p>
</div>
<div class="paragraph">
<p>Also, the current implementation does not support <em>setChildrenAllowed()</em>, which controls whether the user can expand a node by clicking a toggle.
The toggle is by default visible for all nodes, even if they have no children.
The method is not supported because it would require storing the information outside the entities.
You can override <span class="method">areChildrenAllowed()</span> to implement the functionality using a custom logic.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Customize JPAContainer to define the logic for
// displaying the node expansion indicator
JPAContainer&lt;CelestialBody&gt; bodies =
        new JPAContainer&lt;CelestialBody&gt;(CelestialBody.class) {
    @Override
    public boolean areChildrenAllowed(Object itemId) {
        // Some simple logic
        return getChildren(itemId).size() &gt; 0;
    }
};
bodies.setEntityProvider(
    new CachingLocalEntityProvider&lt;CelestialBody&gt;(
        CelestialBody.class, em));</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.entityprovider">5. Entity Providers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Entity providers provide access to entities persisted in a data store.
They are essentially wrappers over a JPA entity manager with optimizations and other features important when binding persistent data to a user interface.</p>
</div>
<div class="paragraph">
<p>The choice and use of entity providers is largely invisible if you create your <span class="class">JPAContainer</span> instances with the <span class="class">JPAContainerFactory</span>, which hides such details.</p>
</div>
<div class="paragraph">
<p>JPAContainer entity providers can be customized, which is necessary for some purposes.
Entity providers can be Enterprise JavaBeans (EJBs), which is useful when you use them in a Java EE application server.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.entityprovider.built_in">5.1. Built-In Entity Providers</h3>
<div class="paragraph">
<p>JPAContainer includes various kinds of built-in entity providers: caching and non-caching, read-write and read-only, and batchable.</p>
</div>
<div class="paragraph">
<p><em>Caching</em> is useful for performance, but takes some memory for the cache and makes the provider stateful. <em>Batching</em>, that is, running updates in larger batches, can also enhance performance and be used together with caching.
It is stateless, but doing updates is a bit more complex than otherwise.</p>
</div>
<div class="paragraph">
<p>Using a <em>read-only</em> container is preferable if read-write capability is not needed.</p>
</div>
<div class="paragraph">
<p>All built-in providers are <em>local</em> in the sense that they provide access to entities using a local JPA entity manager.</p>
</div>
<div class="paragraph">
<p>The <span class="class">CachingMutableLocalEntityProvider</span> is usually recommended as the first choise for read-write access and <span class="class">CachingLocalEntityProvider</span> for read-only access.</p>
</div>
<div class="sect3">
<h4 id="__span_class_class_localentityprovider_span">5.1.1. <span class="class">LocalEntityProvider</span></h4>
<div class="paragraph">
<p>A read-only, lazy loading entity provider that does not perform caching and reads its data directly from an entity manager.</p>
</div>
<div class="paragraph">
<p>You can create the provider with <span class="method">makeNonCachedReadOnly()</span> method in <span class="class">JPAContainerFactory</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__span_class_class_mutablelocalentityprovider_span">5.1.2. <span class="class">MutableLocalEntityProvider</span></h4>
<div class="paragraph">
<p>Extends <span class="class">LocalEntityProvider</span> with write support.
All changes are directly sent to the entity manager.</p>
</div>
<div class="paragraph">
<p>Transactions can be handled either internally by the provider, which is the default, or by the container.
In the latter case, you can extend the class and annotate it, for example, as described in <a href="#_jpacontainer.entityprovider.built_in">jpacontainer.entityprovider.built-in</a>.</p>
</div>
<div class="paragraph">
<p>The provider can notify about updates to entities through the <span class="interface">EntityProviderChangeNotifier</span> interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="__span_class_class_batchablelocalentityprovider_span">5.1.3. <span class="class">BatchableLocalEntityProvider</span></h4>
<div class="paragraph">
<p>A simple non-caching implementation of the <span class="interface">BatchableEntityProvider</span> interface.
It extends <span class="class">MutableLocalEntityProvider</span> and simply passes itself to the <span class="method">batchUpdate()</span> callback method.
This will work properly if the entities do not contain any references to other entities that are managed by the same container.</p>
</div>
</div>
<div class="sect3">
<h4 id="__span_class_class_cachinglocalentityprovider_span">5.1.4. <span class="class">CachingLocalEntityProvider</span></h4>
<div class="paragraph">
<p>A read-only, lazy loading entity provider that caches both entities and query results for different filter/sortBy combinations.
When the cache gets full, the oldest entries in the cache are removed.
The maximum number of entities and entity IDs to cache for each filter/sortBy combination can be configured in the provider.
The cache can also be manually flushed.
When the cache grows full, the oldest items are removed.</p>
</div>
<div class="paragraph">
<p>You can create the provider with <span class="method">makeReadOnly()</span> method in <span class="class">JPAContainerFactory</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__span_class_class_cachingmutablelocalentityprovider_span">5.1.5. <span class="class">CachingMutableLocalEntityProvider</span></h4>
<div class="paragraph">
<p>Just like <span class="class">CachingLocalEntityProvider</span>, but with read-write access.
For read access, caching works just like in the read-only provider.
When an entity is added or updated, the cache is flushed in order to make sure the added or updated entity shows up correctly when using filters and/or sorting.
When an entity is removed, only the filter/sortBy-caches that actually contain the item are flushed.</p>
</div>
<div class="paragraph">
<p>This is perhaps the most commonly entity provider that you should consider using for most tasks.
You can create it with the <span class="method">make()</span> method in <span class="class">JPAContainerFactory</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="__span_class_class_cachingbatchablelocalentityprovider_span">5.1.6. <span class="class">CachingBatchableLocalEntityProvider</span></h4>
<div class="paragraph">
<p>This provider supports making updates in <em>batches</em>.
You need to implement a <span class="interface">BatchUpdateCallback</span> that does all the updates and execute the batch by calling <span class="method">batchUpdate()</span> on the provider.</p>
</div>
<div class="paragraph">
<p>The provider is an extension of the <span class="class">CachingMutableLocalEntityProvider</span> that implements the <span class="interface">BatchableEntityProvider</span>                    interface.
This will work properly if the entities do not contain any references to other entities that are managed by the same container.</p>
</div>
<div class="paragraph">
<p>You can create the provider with <span class="method">makeBatchable()</span> method in <span class="class">JPAContainerFactory</span>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.entityprovider.jndi">5.2. Using JNDI Entity Providers in JEE6 Environment</h3>
<div class="paragraph">
<p>JPAContainer 2.0 introduced a new set of entity providers specifically for working in a <span class="literal">JEE6</span> environment.
In a JEE environment, you should use an entity manager provided by the application server and, usually, <span class="literal">JTA</span> transactions instead of transactions provided by JPA.
Entity providers in  package work mostly the same way as the normal providers discussed earlier, but use JNDI lookups to get reference to an <span class="interface">EntityManager</span> and to a JTA transaction.</p>
</div>
<div class="paragraph">
<p>The JNDI providers work with almost no special configuration at all.
The <span class="class">JPAContainerFactory</span> has factory methods for creating various JNDI provider types.
The only thing that you commonly need to do is to expose the <span class="interface">EntityManager</span>            	to a JNDI address.
By default, the JNDI providers look for the <span class="interface">EntityManager</span> from "".  This can be done with the following snippet in <em class="path">web.xml</em> or with similar configuration with annotations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;persistence-context-ref&gt;
  &lt;persistence-context-ref-name&gt;
    persistence/em
  &lt;/persistence-context-ref-name&gt;
  &lt;persistence-unit-name&gt;MYPU&lt;/persistence-unit-name&gt;
&lt;/persistence-context-ref&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The "<span class="literal">MYPU</span>" is the identifier of your persistence unit defined in your <em class="path">persistence.xml</em> file.</p>
</div>
<div class="paragraph">
<p>If you choose to annotate your servlets (instead of using the <em class="path">web.xml</em> file as described above), you can simply add the following annotation to your servlet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@PersistenceContext(name="persistence/em",unitName="MYPU")</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wish to use another address for the persistence context, you can define them with the <span class="method">setJndiAddresses()</span>            	method.
You can also define the location for the JTA <span class="class">UserTransaction</span>, but that should be always accessible from "" by the JEE6 specification.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.entityprovider.ejb">5.3. Entity Providers as Enterprise Beans</h3>
<div class="paragraph">
<p>Entity providers can be Enterprise JavaBeans (EJB). This may be useful if you use JPAContainer in a Java EE application server.
In such case, you need to implement a custom entity provider that allows the server to inject the entity manager.</p>
</div>
<div class="paragraph">
<p>For example, if you need to use Java Transaction API (JTA) for JPA transactions, you can implement such entity provider as follows.
Just extend a built-in entity provider of your choise and annotate the entity manager member as <span class="literal">@PersistenceContext</span>.
Entity providers can be either stateless or stateful session beans.
If you extend a caching entity provider, it has to be stateful.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@Stateless
@TransactionManagement
public class MyEntityProviderBean extends
    MutableLocalEntityProvider&lt;MyEntity&gt; {

    @PersistenceContext
    private EntityManager em;

    protected LocalEntityProviderBean() {
        super(MyEntity.class);
        setTransactionsHandledByProvider(false);
    }

    @Override
    @TransactionAttribute(TransactionAttributeType.REQUIRED)
    protected void runInTransaction(Runnable operation) {
        super.runInTransaction(operation);
    }

    @PostConstruct
    public void init() {
        setEntityManager(em);
        /*
         * The entity manager is transaction-scoped, which means
         * that the entities will be automatically detached when
         * the transaction is closed. Therefore, we do not need
         * to explicitly detach them.
         */
        setEntitiesDetached(false);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have more than one EJB provider, you might  want to create an abstract super class of the above  and only define the entity type in implementations.
You can implement an entity provider as a managed bean in Spring Framefork the same way.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.filtering">6. Filtering <span class="class">JPAContainer</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Normally, a <span class="class">JPAContainer</span> contains all instances of a particular entity type in the persistence context.
Hence, it is equivalent to a database table or query.
Just like with database queries, you often want to narrow the results down. <span class="class">JPAContainer</span> implements the <span class="interface">Filterable</span> interface in Vaadin containers, described in <a href="#_datamodel.container.filtered">datamodel.container.filtered</a>.
All filtering is done at the database level with queries, not in the container.</p>
</div>
<div class="paragraph">
<p>For example, let us filter all the people older than 117:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Filter filter = new Compare.Greater("age", 117);
persons.addContainerFilter(filter);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would create a JPQL query somewhat as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>SELECT id FROM Person WHERE (AGE &gt; 117)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The filtering implementation uses the JPA 2.0 Criteria API transparently.
As the filtering is done at the database-level, custom filters that use the <span class="interface">Filterable</span> API do not work.</p>
</div>
<div class="paragraph">
<p>When using Hibernate, note that it does not support implicit joins.
See <a href="#_jpacontainer.hibernate.joins">jpacontainer.hibernate.joins</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.filtering.criteria_api">7. Querying with the Criteria API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the <span class="interface">Filterable</span> API is not enough and you need to have more control, you can make queries directly with the JPA Criteria API.
You may also need to customize sorting or joins, or otherwise modify the query in some way.
To do so, you need to implement a <span class="interface">QueryModifierDelegate</span> that the JPAContainer entity provider calls when making a query.
The easiest way to do this is to extend <span class="class">DefaultQueryModifierDelegate</span>, which has empty implementations of all the methods so that you can only override the ones you need.</p>
</div>
<div class="paragraph">
<p>The entity provider calls specific <span class="interface">QueryModifierDelegate</span> methods at different stages while making a query.
The stages are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start building a query</p>
</li>
<li>
<p>Add "<span class="literal">ORDER BY</span>" expression</p>
</li>
<li>
<p>Add "<span class="literal">WHERE</span>" expression (filter)</p>
</li>
<li>
<p>Finish building a query</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Methods where you can modify the query are called before and after each stage as listed in the following table:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. <span class="class">QueryModifierDelegate</span> Methods</caption>
<colgroup>
<col style="width: 100%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">queryWillBeBuilt()</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderByWillBeAdded()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">orderByWasAdded()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filtersWillBeAdded()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">filtersWereAdded()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">queryHasBeenBuilt()</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>All the methods get two parameters.
The <span class="interface">CriteriaBuilder</span> is a builder that you can use to build queries.
The <span class="interface">CriteriaQuery</span> is the query being built.</p>
</div>
<div class="paragraph">
<p>You can use the <span class="method">getRoots().iterator().next()</span> in <span class="interface">CriteriaQuery</span> to get the "root" that is queried, for example, the <span class="literal">PERSON</span> table, etc.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.filtering.criteria_api.filters">7.1. Filtering the Query</h3>
<div class="paragraph">
<p>Let us consider a case where we modify the query for a <span class="class">Person</span> container so that it includes only people over 116.
This trivial example is identical to the one given earlier using the <span class="class">Filterable</span> interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>persons.getEntityProvider().setQueryModifierDelegate(
        new DefaultQueryModifierDelegate () {
    @Override
    public void filtersWillBeAdded(
            CriteriaBuilder criteriaBuilder,
            CriteriaQuery&lt;?&gt; query,
            List&lt;Predicate&gt; predicates) {
        Root&lt;?&gt; fromPerson = query.getRoots().iterator().next();

        // Add a "WHERE age &gt; 116" expression
        Path&lt;Integer&gt; age = fromPerson.&lt;Integer&gt;get("age");
        predicates.add(criteriaBuilder.gt(age, 116));
    }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.filtering.criteria_api.compatibility">7.2. Compatibility</h3>
<div class="paragraph">
<p>When building queries, you should consider the capabilities of the different JPA implementations.
Regarding Hibernate, see <a href="#_jpacontainer.hibernate.joins">jpacontainer.hibernate.joins</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.fieldfactory">8. Automatic Form Generation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The JPAContainer <span class="class">FieldFactory</span> is an implementation of the <span class="interface">FormFieldFactory</span> and <span class="interface">TableFieldFactory</span> interfaces that can generate fields based on JPA annotations in a POJO.
It goes further than the <span class="class">DefaultFieldFactory</span>, which only creates simple fields for the basic data types.
This way, you can easily create forms to input entities or enable editing in tables.</p>
</div>
<div class="paragraph">
<p>The generated defaults are as follows:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Annotation</th>
<th class="tableblock halign-left valign-top">Class Mapping</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@ManyToOne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NativeSelect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@OneToOne, @Embedded</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nested Form</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@OneToMany, @ElementCollection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MasterDetailEditor (see below)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">@ManyToMany</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selectable Table</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The field factory is recusive, so that you can edit a complex object tree with one form.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.fieldfactory.configuring">8.1. Configuring the Field Factory</h3>
<div class="paragraph">
<p>The <span class="class">FieldFactory</span> is highly configurable with various configuration settings and by extending.</p>
</div>
<div class="paragraph">
<p>The <span class="method">setMultiSelectType()</span> and <span class="method">setSingleSelectType()</span> allow you to specify a selection component that is used instead of the default for a field with <span class="literal">@ManyToMany</span> and <span class="literal">@ManyToOne</span>                annotation, respectively.
The first parameter is the class type of the field, and the second parameter is the class type of a selection component.
It must be a sub-class of <span class="class">AbstractSelect</span>.</p>
</div>
<div class="paragraph">
<p>The <span class="method">setVisibleProperties()</span> controls which properties (fields) are visible in generated forms, subforms, and tables.
The first paramater is the class type for which the setting should be made, followed by the IDs of the visible properties.</p>
</div>
<div class="paragraph">
<p>The configuration should be done before binding the form to a data source as that is when the field generation is done.</p>
</div>
<div class="paragraph">
<p>Further configuration must be done by extending the many protected methods.
Please see the API documentation for the complete list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.fieldfactory.using">8.2. Using the Field Factory</h3>
<div class="paragraph">
<p>The most basic use case for the JPAContainer <span class="class">FieldFactory</span> is with a <span class="class">Form</span>                bound to a container item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>// Have a persistent container
final JPAContainer&lt;Country&gt; countries =
    JPAContainerFactory.make(Country.class, "book-examples");

// For selecting an item to edit
final ComboBox countrySelect =
    new ComboBox("Select a Country", countries);
countrySelect.setItemCaptionMode(Select.ITEM_CAPTION_MODE_PROPERTY);
countrySelect.setItemCaptionPropertyId("name");

// Country Editor
final Form  countryForm  = new Form();
countryForm.setCaption("Country Editor");
countryForm.addStyleName("bordered"); // Custom style
countryForm.setWidth("420px");
countryForm.setBuffered(true);
countryForm.setEnabled(false);

// When an item is selected from the list...
countrySelect.addValueChangeListener(new ValueChangeListener(){
    @Override
    public void valueChange(ValueChangeEvent event) {
        // Get the item to edit in the form
        Item countryItem =
            countries.getItem(event.getProperty().getValue());

        // Use a JPAContainer field factory
        //  - no configuration is needed here
        final FieldFactory fieldFactory = new FieldFactory();
        countryForm.setFormFieldFactory(fieldFactory);

        // Edit the item in the form
        countryForm.setItemDataSource(countryItem);
        countryForm.setEnabled(true);

        // Handle saves on the form
        final Button save = new Button("Save");
        countryForm.getFooter().removeAllComponents();
        countryForm.getFooter().addComponent(save);
        save.addClickListener(new ClickListener() {
            @Override
            public void buttonClick(ClickEvent event) {
                try {
                    countryForm.commit();
                    countryForm.setEnabled(false);
                } catch (InvalidValueException e) {
                }
            }
        });
    }
});
countrySelect.setImmediate(true);
countrySelect.setNullSelectionAllowed(false);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would create a form shown in <a href="#_figure.jpacontainer.fieldfactory.using">figure.jpacontainer.fieldfactory.using</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/jpacontainer/fieldfactory-form.png" alt="fieldfactory form">
</div>
<div class="title">Figure 6. Using FieldFactory with One-to-Many Relationship</div>
</div>
<div class="paragraph">
<p>If you use Hibernate, you also need to pass an <span class="class">EntityManagerPerRequestHelper</span>, either for the constructor or with <span class="method">setEntityManagerPerRequestHelper()</span>, as described in <a href="#_jpacontainer.hibernate.em_per_request">jpacontainer.hibernate.em-per-request</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.fieldfactory.masterdetaileditor">8.3. Master-Detail Editor</h3>
<div class="paragraph">
<p>The <span class="class">MasterDetailEditor</span> is a field component that allows editing an item property that has one-to-many relationship.
The item can be a row in a table or bound to a form.
It displays the referenced collection as an editable <span class="class">Table</span> and allows adding and removing items in it.</p>
</div>
<div class="paragraph">
<p>You can use the <span class="class">MasterDetailEditor</span> manually, or perhaps more commonly use a JPAContainer <span class="class">FieldFactory</span> to create it automatically.
As shown in the example in <a href="#_figure.jpacontainer.fieldfactory.using">figure.jpacontainer.fieldfactory.using</a>, the factory creates a <span class="class">MasterDetailEditor</span> for all properties with a <span class="literal">@OneToMany</span> or an <span class="literal">@ElementCollection</span>                annotation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jpacontainer.hibernate">9. Using JPAContainer with Hibernate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hibernate needs special handling in some cases.</p>
</div>
<div class="sect2">
<h3 id="_jpacontainer.hibernate.lazyloading">9.1. Lazy loading</h3>
<div class="paragraph">
<p>In order for lazy loading to work automatically, an entity must be attached to an entity manager.
Unfortunately, Hibernate can not keep entity managers for long without problems.
To work around the problem, you need to use a special lazy loading delegate for Hibernate.</p>
</div>
<div class="paragraph">
<p>JPAContainer entity providers handle lazy loading in delegates defined by the <span class="interface">LazyLoadingDelegate</span> interface.
The default implementation for Hibernate is defined in <span class="class">HibernateLazyLoadingDelegate</span>.
You can instantiate one and use it in an entity provider with <span class="method">setLazyLoadingDelegate()</span>.</p>
</div>
<div class="paragraph">
<p>The default implementation works so that whenever a lazy property is accessed through the Vaadin  interface, the value is retrieved with a separate (JPA Criteria API) query using the currently active entity manager.
The value is then manually attached to the entity instance, which is detached from the entity manager.
If this default implementation is not good enough, you may need to make your own implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.hibernate.em_per_request">9.2. The EntityManager-Per-Request pattern</h3>
<div class="paragraph">
<p>One issue with Hibernate is that it is designed for short-lived sessions, but the lifetime of an entity manager is normally roughly that of a user session.
The problem is that if an error occurs in a session or an entity manager, the manager becomes unuseable.
This causes big problems with long-lived sessions that would work fine with EclipseLink.</p>
</div>
<div class="paragraph">
<p>The recommended solution is to use the <em>EntityManager-per-Request</em> pattern.
It is highly recommended always when using Hibernate.</p>
</div>
<div class="paragraph">
<p>An entity manager can only be open during the request-response cycle of the Vaadin servlet, so that one is created at the beginning of the request and closed at the end.</p>
</div>
<div class="sect3">
<h4 id="_jpacontainer.hibernate.em_per_request.provider">9.2.1. Storing an Entity Manager</h4>
<div class="paragraph">
<p>You first need to implement an <span class="interface">EntityManagerProvider</span> that returns a stored <span class="interface">EntityManager</span> with <span class="method">getEntityManager()</span>.
The entity manager must be stored in a <span class="class">ThreadLocal</span> variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>public class LazyHibernateEntityManagerProvider
       implements EntityManagerProvider {
    private static ThreadLocal&lt;EntityManager&gt;
        entityManagerThreadLocal =
            new ThreadLocal&lt;EntityManager&gt;();

    @Override
    public EntityManager getEntityManager() {
        return entityManagerThreadLocal.get();
    }

    public static void setCurrentEntityManager(
                               EntityManager em) {
        entityManagerThreadLocal.set(em);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to create and store the per-request instance at the beginning of each request with <span class="method">setCurrentEntityManager()</span> and clear it at the end by setting it as <span class="literal">null</span>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_jpacontainer.hibernate.em_per_request.provider">9.2.2. Creating Entity Managers in a Servlet Filter</h4>
<div class="paragraph">
<p>You can create the entity managers for each request either by extending <span class="class">VaadinServlet</span> and overriding the <span class="method">service()</span> method or by implementing a servlet filter.
In the following, we describe how to implement a servlet filter to do the task, but overriding the servlet could be even easier.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>public class LazyHibernateServletFilter
       implements Filter {

    private EntityManagerFactory entityManagerFactory;

    @Override
    public void init(FilterConfig filterConfig)
            throws ServletException {
        entityManagerFactory = Persistence
            .createEntityManagerFactory("lazyhibernate");
    }

    @Override
    public void doFilter(ServletRequest servletRequest,
                         ServletResponse servletResponse,
                         FilterChain filterChain)
            throws IOException, ServletException {
        try {
            // Create and set the entity manager
            LazyHibernateEntityManagerProvider
                .setCurrentEntityManager(
                    entityManagerFactory
                        .createEntityManager());

            // Handle the request
            filterChain.doFilter(servletRequest,
                                 servletResponse);
        } finally {
            // Reset the entity manager
            LazyHibernateEntityManagerProvider
                    .setCurrentEntityManager(null);
        }
    }

    @Override
    public void destroy() {
        entityManagerFactory = null;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to define the servlet filter in the <em class="path">web.xml</em> deployment descriptor as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;filter&gt;
    &lt;filter-name&gt;LazyHibernateServletFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;com.example.LazyHibernateServletFilter&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;LazyHibernateServletFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <span class="literal">url-pattern</span> must match the pattern for your Vaadin servlet.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpacontainer.hibernate.joins">9.3. Joins in Hibernate vs EclipseLink</h3>
<div class="paragraph">
<p>EclipseLink supports implicit joins, while Hibernate requires explicit joins.
In SQL terms, an explicit join is a "<span class="literal">FROM a INNER JOIN b
                ON a.bid = b.id</span>" expression, while an implicit join is done in a WHERE clause, such as: "<span class="literal">FROM a,b WHERE a.bid = b.id</span>".</p>
</div>
<div class="paragraph">
<p>In a JPAContainer filter with EclipseLink, an implicit join would have form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>new Equal("skills.skill", s)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Hibernate you would need to use <span class="class">JoinFilter</span> for the explicit join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>new JoinFilter("skills", new Equal("skill", s))</code></pre>
</div>
</div>
<div class="paragraph">
<p></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-03-12 09:16:17 EET
</div>
</div>
</body>
</html>